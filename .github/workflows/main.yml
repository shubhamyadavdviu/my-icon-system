name: Icon System Robot

on:
  push:
    paths:
      - 'icons/**'
      - 'CHANGELOG.md'

concurrency:
  group: icon-generation
  cancel-in-progress: true

jobs:
  generate-assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Icon Tool
        run: npm install -g fantasticon

      - name: Generate Font and JSON Mapping
        run: |
          mkdir -p generated

          # 1. Create a strict configuration file
          cat << 'EOF' > .fantasticonrc.json
          {
            "inputDir": "./icons",
            "outputDir": "./generated",
            "fontTypes": ["ttf", "woff2"],
            "assetTypes": ["json", "css"],
            "name": "MyIcons",
            "prefix": "icon"
          }
          EOF

          # 2. Run the tool and tell it to read our config file
          fantasticon -c .fantasticonrc.json

      - name: Generate Dart Code
        run: |
          # This script reads the JSON map and writes the Dart file for the devs
          cat << 'EOF' > generate_dart.js
          const fs = require('fs');

          const mapping = JSON.parse(fs.readFileSync('generated/MyIcons.json', 'utf8'));

          let dartCode = `// GENERATED CODE - DO NOT MODIFY BY HAND
          import 'package:flutter/widgets.dart';

          class MyIcons {
            MyIcons._();

            static const String _fontFamily = 'MyIcons';
            static const String _fontPackage = 'my_design_system_icons';

          `;

          for (const [name, code] of Object.entries(mapping)) {
            const hex = code.toString(16);
            dartCode += `  static const IconData ${name} = IconData(0x${hex}, fontFamily: _fontFamily, fontPackage: _fontPackage);\n`;
          }

          dartCode += "}\n";

          fs.mkdirSync('lib', { recursive: true });
          fs.writeFileSync('lib/my_icons.dart', dartCode);
          EOF

          node generate_dart.js

      - name: Commit and Push Changes (With Retry Loop)
        run: |
          git config --global user.name "Icon-Robot"
          git config --global user.email "robot@github.com"

          # Stage the new font, JSON, and Dart file
          git add generated/ lib/

          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Robot: Automatically generated font and Dart classes [skip ci]"

          n=0
          until [ "$n" -ge 5 ]
          do
             git pull --rebase origin main && git push origin main && break
             n=$((n+1))
             echo "Push rejected. Retrying in 5 seconds... (Attempt $n/5)"
             sleep 5
          done
